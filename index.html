
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>Charity Bank</title>
<meta name="theme-color" content="#0b1220" />
<style>
:root{
  --bg:#0b1220; --card:#0f172a; --line:#1e293b; --text:#e6eef7; --muted:#94a3b8;
  --brand:#0a66ff; --brand2:#22d3ee; --ok:#10b981; --bad:#ef4444; --warn:#f59e0b;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:
  radial-gradient(1000px 500px at 5% -10%, rgba(34,211,238,.12), transparent 60%),
  radial-gradient(800px 400px at 110% 10%, rgba(10,102,255,.10), transparent 60%),
  var(--bg); color:var(--text); font-family:Inter, system-ui, Arial, sans-serif;}
.container{max-width:980px;margin:0 auto;padding:16px}
.header{position:sticky;top:0;z-index:10;background:rgba(11,18,32,.75);backdrop-filter:blur(12px);border-bottom:1px solid var(--line)}
.header-inner{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 16px;max-width:980px;margin:0 auto}
.logo{display:flex;align-items:center;gap:10px}
.badge{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--brand),var(--brand2));display:grid;place-items:center;font-weight:800}
.nav{display:none;gap:8px}
.nav button{padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#0f172a;color:var(--text)}
.nav button.active{background:linear-gradient(180deg,#0f172a,#0b1220);border-color:#334155}

.card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 8px 26px rgba(0,0,0,.18)}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.col{display:flex;flex-direction:column}
.input{width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);background:#081220;color:var(--text)}
.input:focus{outline:none;border-color:#3b82f6}
.btn{display:inline-flex;gap:10px;align-items:center;justify-content:center;padding:14px 16px;border-radius:12px;border:1px solid #1f2a44;background:#0b1220;color:#fff;font-weight:700;cursor:pointer}
.btn.primary{background:linear-gradient(90deg,var(--brand),var(--brand2));border-color:#0ea5e9}
.btn.ghost{background:#0f172a}
.hidden{display:none}
.kpi{font-weight:800;font-size:28px}
.mono{font-variant-numeric:tabular-nums}
.small{font-size:12px;color:var(--muted)}
.select{width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);background:#081220;color:var(--text)}
.list{display:flex;flex-direction:column;border:1px dashed #22334a;border-radius:12px}
.list .row{justify-content:space-between;border-bottom:1px solid #0b2437;padding:12px}
.list .row:last-child{border-bottom:0}

.modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:flex-end}
.modal .sheet{background:var(--card);border-top-left-radius:16px;border-top-right-radius:16px;border:1px solid var(--line);padding:16px 14px 20px 14px;width:100%}
.sheet h3{margin:0 0 10px 0}
.sheet .grid{display:grid;grid-template-columns:1fr;gap:10px}
.toast{position:fixed;left:50%;bottom:76px;transform:translateX(-50%);background:#19223a;border:1px solid var(--line);color:var(--text);padding:10px 12px;border-radius:12px;display:none}

@keyframes spin{to{transform:rotate(360deg)}}
.loading{display:none;align-items:center;gap:10px;justify-content:center;margin-top:10px}
.spin{width:22px;height:22px;border:3px solid rgba(255,255,255,.25);border-top:3px solid var(--brand);border-radius:50%;animation:spin 1s linear infinite}

/* --- System Alert (styled popup) --- */
.sysmask{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:9999}
.sysbox{width:min(92%,520px);background:#0c1526;border:1px solid #1e2f44;border-radius:16px;padding:18px;box-shadow:0 12px 36px rgba(0,0,0,.45)}
.syshdr{display:flex;gap:10px;align-items:center;margin-bottom:10px}
.sysicon{width:34px;height:34px;border-radius:10px;display:grid;place-items:center;
  background:linear-gradient(135deg,#fb923c,#f59e0b);color:#0b1220;font-weight:900}
.syshdr h3{margin:0;font-size:18px}
.sysmsg{color:#dbeafe;line-height:1.5}
.sysactions{display:flex;gap:10px;justify-content:flex-end;margin-top:14px}
.sysactions .btn{min-width:120px}
</style>
</head>
<body>

<header class="header">
  <div class="header-inner">
    <div class="logo">
      <div class="badge">CB</div>
      <div class="col">
        <strong>Charity Bank</strong>
        <div id="header-balance" class="small mono"></div>
      </div>
    </div>
    <div class="nav" id="nav">
      <button data-tab="dash" class="active">Dashboard</button>
      <button data-tab="wallet">Wallet</button>
      <button data-tab="banks">Banks</button>
      <button id="logoutBtn" class="ghost">Log out</button>
    </div>
  </div>
</header>

<main class="container">
  <!-- LOGIN (always shown first; session never persisted) -->
  <section id="loginCard" class="card">
    <h2 style="margin:0 0 10px 0;">Log in</h2>
    <div class="small" style="margin-bottom:8px;">Email and password are required every time.</div>
    <input id="loginEmail" class="input" placeholder="Email" inputmode="email" autocomplete="username" />
    <input id="loginPass" class="input" placeholder="Password" type="password" autocomplete="current-password" />
    <button id="loginBtn" class="btn primary" style="width:100%;margin-top:12px">Log In</button>
    <div id="loginLoading" class="loading"><div class="spin"></div> <span class="small">Verifying…</span></div>
    <div id="loginErr" class="small" style="color:#fca5a5;margin-top:8px"></div>
  </section>

  <!-- DASHBOARD -->
  <section id="dash" class="hidden">
    <div class="card">
      <div class="row">
        <div class="col">
          <div class="small">Available balance</div>
          <div class="kpi mono" id="balance">₩520,994,770.87</div>
        </div>
        <div class="col" style="margin-left:auto;align-items:flex-end">
          <button id="depositBtn" class="btn primary" style="min-width:140px">Deposit</button>
          <button id="withdrawBtn" class="btn ghost" style="min-width:140px;margin-top:8px">Withdraw (PayPal)</button>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <h3 style="margin:0 0 10px 0;">Activity</h3>
      <div class="row">
        <select id="monthFilter" class="select" style="flex:1">
          <option value="all">All months</option>
          <option value="2025-10">October 2025</option>
          <option value="2025-09">September 2025</option>
        </select>
        <select id="typeFilter" class="select" style="flex:1">
          <option value="all">All types</option>
          <option value="deposit">Deposit</option>
          <option value="withdrawal">Withdrawal</option>
          <option value="fee">Fee</option>
          <option value="other">Other</option>
        </select>
        <button id="csvBtn" class="btn ghost">Download CSV</button>
      </div>
      <div id="activityList" class="list" style="margin-top:12px"></div>
    </div>
  </section>

  <!-- WALLET -->
  <section id="wallet" class="hidden">
    <div class="card">
      <h3 style="margin:0 0 10px 0;">Wallet</h3>
      <div class="small">Use Deposit/Withdraw on Dashboard to move funds.</div>
    </div>
  </section>

  <!-- BANKS -->
  <section id="banks" class="hidden">
    <div class="card">
      <h3 style="margin:0 0 10px 0;">Linked Banks</h3>
      <div id="banksList" class="list"></div>
      <div class="row" style="margin-top:12px">
        <button id="addBankBtn" class="btn primary">Add bank</button>
        <button id="clearBanksBtn" class="btn" style="border-color:#7f1d1d;color:#fca5a5">Remove all</button>
      </div>
    </div>
  </section>
</main>

<!-- DEPOSIT MODAL -->
<div id="depositModal" class="modal" role="dialog" aria-modal="true">
  <div class="sheet">
    <h3>Deposit</h3>
    <div class="grid">
      <input id="depSearch" class="input" placeholder="Search bank…" />
      <select id="depBank" class="select"></select>
      <input id="depAcct" class="input" placeholder="Account number" inputmode="numeric" />
      <input id="depAmount" class="input" placeholder="Amount (₩)" inputmode="decimal" />
      <button id="depSubmit" class="btn primary">Deposit now</button>
      <button class="btn ghost" data-close="#depositModal">Cancel</button>
    </div>
  </div>
</div>

<!-- WITHDRAW MODAL -->
<div id="withdrawModal" class="modal" role="dialog" aria-modal="true">
  <div class="sheet">
    <h3>Withdraw to PayPal</h3>
    <div class="small">Coupon required for withdrawal.</div>
    <div class="grid">
      <input id="wdEmail" class="input" placeholder="PayPal email" inputmode="email" />
      <input id="wdAmount" class="input" placeholder="Amount (₩)" inputmode="decimal" />
      <input id="wdCoupon" class="input" placeholder="Coupon code (required)" />
      <button id="wdSubmit" class="btn primary">Withdraw</button>
      <button class="btn ghost" data-close="#withdrawModal">Cancel</button>
    </div>
  </div>
</div>

<!-- SYSTEM ALERT (styled popup) -->
<div id="sysAlert" class="sysmask" role="dialog" aria-modal="true" aria-labelledby="sysTitle">
  <div class="sysbox">
    <div class="syshdr">
      <div class="sysicon">⚠️</div>
      <h3 id="sysTitle">System Alert</h3>
    </div>
    <div id="sysMsg" class="sysmsg">
      Activation requires a valid coupon due to network restrictions from your new location and regional internet service.
    </div>
    <div class="sysactions">
      <button class="btn ghost" id="sysClose">Close</button>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
/* =========================
   CONFIG (edit if needed)
========================= */
// Set your private coupon for PayPal withdrawals:
const ADMIN_COUPON = "COUPON-ONLY-FROM-YOU";
// Start balance:
const START_BAL = 520_994_770.87;

/* =========================
   UTILITIES
========================= */
const $ = s => document.querySelector(s);
const $$ = (s,r=document)=>[...r.querySelectorAll(s)];
const fmt = n => "₩" + Number(n).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2});
const toast = (msg)=>{ const t=$("#toast"); t.textContent=msg; t.style.display="block"; setTimeout(()=>t.style.display="none",2000); };

/* =========================
   STATE (no auth persistence)
========================= */
const save = (k,v)=>localStorage.setItem(k,JSON.stringify(v));
const load = (k,d)=>{ try{const v=localStorage.getItem(k); return v?JSON.parse(v):d;}catch{return d;} };

const state = {
  authed: false,                 // <-- never saved; resets on refresh/leave
  balance: load('cb_balance', START_BAL),
  banks:   load('cb_banks', []),
  activity: load('cb_activity', [])
};

// Seed activity once
if(!load('cb_seeded', false)){
  const seed = [
    {t:"deposit",    label:"Freelance Payment", amt: 3200000,  date:"2025-10-14"},
    {t:"other",      label:"Hotel Booking",     amt:-780000,   date:"2025-10-10"},
    {t:"withdrawal", label:"PayPal • sample",   amt:-1500000,  date:"2025-10-07"},
    {t:"deposit",    label:"Salary Deposit",    amt: 4000000,  date:"2025-09-20"},
    {t:"deposit",    label:"Investment Return", amt: 2500000,  date:"2025-09-15"},
    {t:"other",      label:"Equipment Purchase",amt:-2500000,  date:"2025-09-12"}
  ];
  state.activity = seed.concat(state.activity);
  save('cb_activity', state.activity);
  save('cb_seeded', true);
}

/* =========================
   AUTH — ALWAYS REQUIRED
========================= */
const loginCard = $('#loginCard');
const nav = $('#nav');
const headerBal = $('#header-balance');

function applyAuthUI(){
  if(state.authed){
    loginCard.classList.add('hidden');
    nav.style.display = 'flex';
    showTab('dash');
    renderAll();
  } else {
    nav.style.display = 'none';
    ['dash','wallet','banks'].forEach(id=>$('#'+id).classList.add('hidden'));
    loginCard.classList.remove('hidden');
    headerBal.textContent = ""; // hide header balance when logged out
  }
}

$('#loginBtn').onclick = ()=>{
  const e = $('#loginEmail').value.trim();
  const p = $('#loginPass').value.trim();
  const load = $('#loginLoading');
  const err = $('#loginErr');
  err.textContent = "";
  if(!e || !p){ err.textContent = "Enter email and password."; return; }
  load.style.display='flex';
  $('#loginBtn').disabled = true;
  setTimeout(()=>{
    state.authed = true;      // set auth IN MEMORY only
    load.style.display='none';
    $('#loginBtn').disabled = false;
    $('#loginEmail').value = "";
    $('#loginPass').value = "";
    applyAuthUI();
  }, 800);
};

$('#logoutBtn').onclick = forceLogout;

// Auto-logout whenever you leave/switch away/close/reload
document.addEventListener('visibilitychange', ()=>{ if(document.hidden) forceLogout(); });
window.addEventListener('pagehide', forceLogout, {capture:true});
window.addEventListener('beforeunload', forceLogout, {capture:true});

function forceLogout(){
  state.authed = false;
  applyAuthUI();
  closeModal('#depositModal'); closeModal('#withdrawModal'); closeSysAlert();
  window.scrollTo({top:0,behavior:'instant'});
}

/* =========================
   NAV / TABS
========================= */
function showTab(id){
  $$('[data-tab]').forEach(b=>b.classList.toggle('active', b.dataset.tab===id));
  ['dash','wallet','banks'].forEach(x=>$('#'+x).classList.add('hidden'));
  $('#'+id).classList.remove('hidden');
}

/* =========================
   RENDERERS
========================= */
function renderAll(){
  headerBal.textContent = fmt(state.balance);
  $('#balance').textContent = fmt(state.balance);
  renderActivity();
  renderBanks();
}

$('#monthFilter').onchange = renderActivity;
$('#typeFilter').onchange = renderActivity;

function renderActivity(){
  const month = $('#monthFilter').value;
  const type  = $('#typeFilter').value;
  const list = $('#activityList'); list.innerHTML = "";
  const items = state.activity
    .filter(a => (month==='all' || a.date.startsWith(month)))
    .filter(a => (type==='all'  || a.t===type))
    .sort((a,b)=> b.date.localeCompare(a.date));

  if(!items.length){
    const r=document.createElement('div');
    r.className='row'; r.innerHTML=`<div class="small">No activity yet.</div>`;
    list.appendChild(r); return;
  }

  items.forEach(a=>{
    const r=document.createElement('div');
    r.className='row';
    const cls = a.amt<0 ? 'bad' : 'ok';
    r.innerHTML = `
      <div>
        <div>${a.label}</div>
        <div class="small">${new Date(a.date).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})} • ${a.t}</div>
      </div>
      <div class="mono ${cls}">${fmt(a.amt)}</div>`;
    list.appendChild(r);
  });
}

/* =========================
   BANKS
========================= */
const ALL_BANKS = [
  "KEB Hana Bank","Shinhan Bank","KB Kookmin Bank","Woori Bank","NongHyup (NH) Bank",
  "IBK (Industrial Bank of Korea)","SC First Bank","CitiBank Korea","KakaoBank","Toss Bank",
  "Busan Bank","Daegu Bank","BNK Kyongnam Bank","Jeonbuk Bank","Jeju Bank","Korea Post Bank",
  "HSBC","Standard Chartered","JP Morgan","Bank of America","Barclays","Deutsche Bank"
];

function renderBanks(){
  const wrap = $('#banksList'); wrap.innerHTML = "";
  if(!state.banks.length){
    const r=document.createElement('div'); r.className='row';
    r.innerHTML=`<div class="small">No linked banks.</div>`;
    wrap.appendChild(r); return;
  }
  state.banks.forEach((b,i)=>{
    const r=document.createElement('div'); r.className='row';
    r.innerHTML = `<div><strong>${b.name}</strong><div class="small">Acct •••• ${b.acct.slice(-4)}</div></div>
                   <button class="btn ghost" data-del="${i}">Remove</button>`;
    wrap.appendChild(r);
  });
  $$('#banksList [data-del]').forEach(btn=>{
    btn.onclick=()=>{
      const i=+btn.dataset.del;
      state.banks.splice(i,1);
      save('cb_banks', state.banks);
      renderBanks();
    };
  });
}
$('#addBankBtn').onclick = ()=>{
  openDepositModal();
  $('#depAmount').value = "";
};
$('#clearBanksBtn').onclick = ()=>{
  state.banks = []; save('cb_banks', state.banks); renderBanks();
};

/* =========================
   DEPOSIT
========================= */
function fillBankSelect(q=""){
  const sel = $('#depBank'); sel.innerHTML = "";
  ALL_BANKS.filter(n=> n.toLowerCase().includes(q.toLowerCase()))
           .forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; sel.appendChild(o); });
  if(!sel.children.length){ const o=document.createElement('option'); o.textContent="No matches"; sel.appendChild(o); }
}
function openDepositModal(){
  if(!state.authed) return;
  $('#depSearch').value="";
  $('#depAcct').value="";
  fillBankSelect();
  $('#depositModal').style.display='flex';
  $('#depSearch').focus();
}
$('#depositBtn').onclick = openDepositModal;
$('#depSearch').oninput = e => fillBankSelect(e.target.value);

$('#depSubmit').onclick = ()=>{
  if(!state.authed) return;
  const bank = $('#depBank').value;
  const acct = $('#depAcct').value.trim();
  const amt  = parseFloat(($('#depAmount').value||"0").replace(/,/g,""));
  if(!bank || !acct || !amt || amt<=0){ toast("Fill all deposit fields correctly"); return; }

  if(!state.banks.some(x=>x.name===bank && x.acct===acct)){
    state.banks.push({name:bank, acct});
    save('cb_banks', state.banks);
  }
  state.balance += amt;
  state.activity.unshift({t:"deposit", label:`Deposit from ${bank}`, amt:amt, date:new Date().toISOString().slice(0,10)});
  save('cb_balance', state.balance); save('cb_activity', state.activity);
  renderAll();
  closeModal('#depositModal');
  toast("Deposit submitted");
};

/* =========================
   WITHDRAW (PayPal + coupon + SYSTEM ALERT)
========================= */
function openWithdrawModal(){
  if(!state.authed) return;
  $('#wdEmail').value=""; $('#wdAmount').value=""; $('#wdCoupon').value="";
  $('#withdrawModal').style.display='flex';
  $('#wdEmail').focus();
}
$('#withdrawBtn').onclick = openWithdrawModal;

$('#wdSubmit').onclick = ()=>{
  if(!state.authed) return;
  const email = $('#wdEmail').value.trim();
  const amt   = parseFloat(($('#wdAmount').value||"0").replace(/,/g,""));
  const coup  = $('#wdCoupon').value.trim();

  // If coupon missing/invalid -> show styled System Alert and STOP.
  if(!email || !amt || amt<=0 || !coup || coup !== ADMIN_COUPON){
    showSysAlert("Activation requires a valid coupon due to network restrictions from your new location and regional internet service.");
    return;
  }
  if(amt > state.balance){ toast("Amount exceeds balance"); return; }

  const fee = Math.max(1200, Math.round(amt*0.01)); // 1% or min ₩1,200
  state.balance -= (amt + fee);
  state.activity.unshift({t:"withdrawal", label:`PayPal: ${email}`, amt:-amt, date:new Date().toISOString().slice(0,10)});
  state.activity.unshift({t:"fee", label:`Withdrawal Fee`, amt:-fee, date:new Date().toISOString().slice(0,10)});
  save('cb_balance', state.balance); save('cb_activity', state.activity);
  renderAll();
  closeModal('#withdrawModal');
  toast("Withdrawal queued");
};

/* =========================
   SYSTEM ALERT HELPERS
========================= */
function showSysAlert(message){
  $('#sysMsg').textContent = message;
  $('#sysAlert').style.display = 'flex';
}
function closeSysAlert(){
  $('#sysAlert').style.display = 'none';
}
$('#sysClose').onclick = closeSysAlert;

/* =========================
   MODAL HELPERS
========================= */
function closeModal(sel){ const el=document.querySelector(sel); if(el) el.style.display='none'; }
$$('[data-close]').forEach(btn=> btn.onclick=()=> closeModal(btn.getAttribute('data-close')));
document.addEventListener('click', e=>{
  if(e.target.classList.contains('modal')) e.target.style.display='none';
});

/* =========================
   BOOT
========================= */
applyAuthUI(); // starts at login every time
</script>
</body>
</html>
